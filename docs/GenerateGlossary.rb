require "yaml"

def generateFunction(f)
    name = f.keys.first
    out = ""
    out << "<h3>#{name}</h3>"
    out << "<div>#{f[name]["desc"]}</div>"
    if !f[name]["note"].nil?
        f[name]["note"].each do |n|
            out << "<div>NOTE: #{n}</div>"
        end
    end
    out << %Q~
<div class="codeContainer">
    Source (click to open/close):
    <pre class="code">#{f[name]["source"]}</pre>
</div>~
    out << "<div>Pops:</div>"
    out << "<div>Pushes</div>"
    return out
end

def generateCategory(c)
    out = "<h3>#{c["category"]}</h3>"
    c["functions"].each do |f|
        out << generateFunction(f) << "\n"
    end
    return out
end


glossary = YAML.load_file("Glossary.yaml")

puts %Q~
<html>
    <head>
        <title>
            Charm Function Glossary
        </title>
        <script type="text/javascript">
            function codeClick(e) {
                var elem = e.target;
                var codePre = elem.getElementsByClassName("code")[0];
                if (codePre.classList.contains("code-open")) {
                    codePre.classList.remove("code-open");
                    codePre.style.height = "0";
                } else {
                    codePre.classList.add("code-open");
                    var lineHeight = parseInt(window.getComputedStyle(codePre).lineHeight);
                    codePre.style.height = (codePre.innerHTML.split("\\n").length * lineHeight) + "px";
                }
            }
            function init() {
                var codes = document.getElementsByClassName("codeContainer");
                for (let code of codes) {
                    code.onclick = function (e) { codeClick(e); };
                }
            }
            window.onload = init;
        </script>
        <style type="text/css">
            .code {
                overflow-y: hidden;
                background-color: #ccc;
                height: 0;
                padding: 0;
                transition: height 0.5s linear;
                transition: padding 0.5s linear;
            }

            .code-open {
                padding: 1em;
            }
        </style>
    </head>
    <body>
        <h1>
            Charm Function Glossary
        </h1>
        <p>
            This page was autogenerated by docs/GenerateGlossary.rb on #{Time.now}. It lists all of the functions in the Charm glossary in an easy to read, useful reference format.
        </p>
        <h2>
            Native Functions
        </h2>
        #{glossary["native_functions"].map { |c| generateCategory c }.join("\n")}
        <h2>
            Prelude Functions
        </h2>
</html>~
